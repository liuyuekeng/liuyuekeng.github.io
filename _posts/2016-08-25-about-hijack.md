---
layout: post
title: "关于劫持的二三事"
date: 2016-08-25 00:15:25
categories:
---
的通信信道进行了加密，可以有效地防御中间人攻击。

据我这边项目的统计，切换https之后能够减少占页面总流量7%左右的运营商劫持。
至于https带来的性能问题，与本文主旨无关，不再赘述。

## 浏览器劫持

一般说到劫持有一种误区，觉得https之后就万事大吉了。
而实际上https只能保护信道的安全，后面的每一个环节都有可能被恶意篡改。

浏览器劫持实际上花样比较多，这里分开几块来讲

### 链接劫持

1. 计费链接

    假设你页面里面有一个广告，广告跳转链接中带了你的渠道号，给你计费。
    浏览器可能会匹配这些广告的URL，然后篡改渠道号，把所有用他家浏览器的广告，
    劫持成为他自己的流量。

    这个问题其实是接口设计问题，广告计费标示这种东西如果不做签名，很容易被人搞。
    只能通过接口升级来避免这种情况，方法很多，但殊途同归。
    比如广告链接在后端生成，增加物料id和渠道号签名防止篡改。
    或者是广告提供方提供物料时提供加密过的跳转链接。

2. 资源链接

    或者你的页面里面有资源下载，下载的资源中带了你的渠道号，给你计费。
    浏览器也可以通过链接与资源的对应关系进行劫持。把下载的资源替换成自己渠道的资源，把你的钱抢了。

    这种资源下载被劫持主要是因为资源下载链接是固定的一一对应关系，容易被浏览器抓到。
    解决方法是，把链接加盐，加时间戳，然后加密，保证每次生成的下载链接都不一样。
    资源存储的地方做对应的解密，避免被浏览器得知映射关系。
    这件事情实际上成本比较高，对很多网站来说，资源存储不一定是自己搭建的服务，
    或者是资源上了CDN，并不是每个公司都能自建CDN服务的，这时候就比较无奈了。

### 资源劫持

实际上，针对资源下载的劫持还有更过分的方式。
假设你已经把资源链接加密了，浏览器仍然可以对你施行劫持。
简单来说，即使资源的链接是变动的，但资源本身是不变的。
浏览器要做的不再是劫持链接，而是用你加密过的链接去请求部分资源，通过部分资源的特征来识别资源的内容，进而施行劫持。

比如通过资源返回的etag头，或者是通过请求的range头控制返回资源的特定部分（比如末尾256个字节），
这些资源本身的特征来与资源进行映射。
无论etag头或者是range头，都是http协议中用于断点续传的字段，许多正常的下载器进行分片下载的时候都会用到，
屏蔽这样的http头并不现实，非常讨厌。技术上并没有很好的解决方案，只能通过识别这些资源嗅探请求的特征进行被动的防御。

### 页面劫持

简单来说，就是浏览器加载页面后，向页面中植入代码。
把你页面的一部分（比如下载按钮）直接替换掉，他自己实现一遍，变成他的资源下载。

这种只有站点规模达到一定程度，才会被针对性地搞。
防御方式非常被动，只能见招拆招，比如监控页面然后把植入的代码挪走，或者修改DOM结构使代码失效等。
实际上这种情况下重在发现问题，需要通过监控等手段，尽早发现被人搞了，再相应地做出对策。

## 写在最后

这些事情都是我在工作中的经历，这也就是我抱怨国内环境差的原因。
不好好做功能，尽想些歪门邪道互相伤害，无端地被消耗许多人力做这些对社会一点意义都没有的事情。

web页面跑在别人的浏览器沙盒里面，防御起来地位非常被动，没有什么万全的办法。
所以在这样的环境下，站点需要全面的监控，才能及早发现及早解决。

我不是针对谁，但国内的浏览器都是垃圾。怨过不少次国内环境太差，原因有种种，最恶心的莫过于劫持了。

## 运营商劫持

