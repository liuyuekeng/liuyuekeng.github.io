---
layout: post
title:  "《白帽子讲web安全》服务端应用安全"
date:   2015-11-3 22:14:00
categories: 书评
---

##写在前面

工作中会用到PHP，但位置也不会太靠后，基本就是发发请求拼拼模板之类。
MYSQL更是仅限于用过的程度。

还记得依然是刚入职的时候，老员工告诫我，要改关于数据库相关的时候，
一定要万分小心，叫我最好不要动那一块的代码。
原因有两个，一个是安全问题，另一个是性能问题。

但我并没有充分意识到这个安全问题可能会有多严重。

###注入

我以前一直以为注入这种东西，只要做好转码完全没有问题，
但实际上转码并不能很好的防御注入，算是长见识了。

#####SQL注入都是怎么做的？

攻击者寻找注入的点，也就是所谓的“盲注”，一般是通过构造简单的条件语句来判断漏洞是否存在。
比如加上` and 1=1`和` and 1=2`页面展示如果不一样就可以知道注入成功了。

当简单的条件判断无法看出异常的时候，另一种方式叫做timimg attack，
利用像MYSQL中的BENCHMARK这种性能测试函数多次执行，让返回结果的时间比平常的长。

通过这些方式，可以逐个遍历判断数据库名，用户名，数据库版本甚至猜密码等。
然后如果当前数据库用户还有写权限，那就等着被拖库吧。
利用读写文件的操作，攻击者可以获取信息，甚至导出webshell给你开个后门。

除了使用webshell，还有一种是利用用户自定义函数来执行系统命令。
先把库文件上传到数据库访问路径下，然后创建自定义函数，就可以执行系统命令了，root指日可待。

与用户自定义函数类似的还有存储过程，这是数据库内置的一些功能，可以执行系统命令。

另外还有一些利用字符集不同，绕过转义；利用超长截断的属性插入同名数据等奇怪的技巧。

#####注入怎么防御？

escape是不够的，因为攻击者构造注入代码的时候，往往不需要使用这些字符，
所以并不能因为做了escape就觉得可以放心了

最靠谱的方式就是使用预编译语句了，变量用？表示，SQL的结构不会被改变。

另一种方式是使用存储过程，先将SQL语句定义在数据库中使用
（尽量使用静态SQL，动态SQL仍然会存在注入）

数据检查，根据语义过滤输入（邮箱，日期，数字等）

使用安全函数做过滤，编码虽然有可能被绕过，但还是有必要的。

权限问题，这个是最重要的一点，web应用不要使用root账户，
不要使用高权限用户连数据库，不要给自定义函数，操作本地文件的权限。
遵循最小权限原则，即使被注入了也能一定程度上限制影响范围。
