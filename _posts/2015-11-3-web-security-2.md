---
layout: post
title:  "《白帽子讲web安全》关于注入"
date:   2015-11-3 22:14:00
categories: 书评
---

##写在前面

工作中会用到PHP，但位置也不会太靠后，基本就是发发请求拼拼模板之类。
MYSQL更是仅限于用过的程度。

还记得依然是刚入职的时候，老员工告诫我，要改关于数据库相关的时候，
一定要万分小心，叫我最好不要动那一块的代码。
原因有两个，一个是安全问题，另一个是性能问题。

但我并没有充分意识到这个安全问题可能会有多严重。

##注入

我以前一直以为注入这种东西，只要做好转码完全没有问题，
但实际上转码并不能很好的防御注入，算是长见识了。

#####SQL注入都是怎么做的？

攻击者寻找注入的点，也就是所谓的“盲注”，一般是通过构造简单的条件语句来判断漏洞是否存在。
比如加上` and 1=1`和` and 1=2`页面展示如果不一样就可以知道注入成功了。

当简单的条件判断无法看出异常的时候，另一种方式叫做timimg attack，
利用像MYSQL中的BENCHMARK这种性能测试函数多次执行，让返回结果的时间比平常的长。

通过这些方式，可以逐个遍历判断数据库名，用户名，数据库版本甚至猜密码等。
然后如果当前数据库用户还有写权限，那就等着被拖库吧。
利用读写文件的操作，攻击者可以获取信息，甚至导出webshell给你开个后门。

除了使用webshell，还有一种是利用用户自定义函数来执行系统命令。
先把库文件上传到数据库访问路径下，然后创建自定义函数，就可以执行系统命令了，root指日可待。

与用户自定义函数类似的还有存储过程，这是数据库内置的一些功能，可以执行系统命令。

另外还有一些利用字符集不同，绕过转义；利用超长截断的属性插入同名数据等奇怪的技巧。

#####SQL注入怎么防御？

escape是不够的，因为攻击者构造注入代码的时候，往往不需要使用这些字符，
所以并不能因为做了escape就觉得可以放心了

最靠谱的方式就是使用预编译语句了，变量用？表示，SQL的结构不会被改变。

另一种方式是使用存储过程，先将SQL语句定义在数据库中使用
（尽量使用静态SQL，动态SQL仍然会存在注入）

数据检查，根据语义过滤输入（邮箱，日期，数字等）

使用安全函数做过滤，编码虽然有可能被绕过，但还是有必要的。

权限问题，这个是最重要的一点，web应用不要使用root账户，
不要使用高权限用户连数据库，不要给自定义函数，操作本地文件的权限。
遵循最小权限原则，即使被注入了也能一定程度上限制影响范围。

#####XML注入

如果不做输入检查，可能被插入而已数据，只要把语言本身的保留字转义就可以，比较简单。

#####代码注入

这种基本属于自己作死才会出现的情况，通常是使用了不安全的函数，比如js中的eval函数。
不要使用可以执行命令的函数，也不要在脚本中动态include远程文件。

#####CRLF注入

CR是\r，LF是\n，换行符的插入往往会改变语义。
比如按换行分割的日志，有可能被插入换行符导致log注入
或者在HTTP头中被插入了换行符（HTTP头就是用\r\n来分割的），可以添加一些安全相关的头，
或者注入两个换行提前跳到body等等。

一般用户控制的并且会写到HTTP头里的就是cookie啦，在往HTTP头里面写东西要过滤换行符。

##文件上传

攻击者上传了可执行文件到web容器里，然后被执行了，也就是所谓的webshell。

文件上传本来是一个正常的功能，但有时候安全检查做的不到位，就会扑街。这往往不是我们自己代码的问题。

限制文件上传的策略一般就是文件后缀检查，或更严格一点的文件头检查。

首先是方法本身并不可靠，后缀名并不能与文件真正的类型画上等号，文件头也有可能伪造。
其次是策略有可能不可靠，尽量应该使用白名单而不是黑名单来做验证。
最后是第三方库中的文件上传代码很可能包含漏洞，并不能完全信任。

有些服务器的配置也造成文件被解析的情况。

* apache对文件名解析是从后往前进项，直到遇到能识别的类型为止。
    所以a.php.rea会被认为是php类型，而上传的时候可能只检查了rar后缀。导致脚本被解析
* 文件名截断0x00字符，分号等，IIS6遇到`path/xx.asp;abc.jpg`会丢掉abc.jpg不管导致asp脚本执行
* PUT方法开启
* PHP递归路径查询有一个bug，可能导致脚本解析。可以通过cgi.fix_pathinfo为0阻止

这些乱起八早的方法，还有乱七八糟的服务器bug我们不可能都知道。
所以，最重要的点不是限制非法文件的上传，而是即使文件被上传了，也不会被web容器解析执行。
这样才能保证攻击不能生效。

* 文件上传目录分开，或者独立存储，可以优化性能，也可以杜绝脚本执行
* 文件判断类型使用白名单，对图片压缩或使用resize破坏图片中可能包含的代码
* 随机改写文件名和路径，这有几个好处。
    一是用户可以上传，但不能访问；二是根据命名做的手脚会失效；三是不能上传某些特定的配置文件了
* 单独设置文件服务器域名
